# Chapter10
This module we will look at the YAML Config file

# Name: YAML Configuration File

# Description: 

Introduction to Kubernetes Configuration File

    The 3 parts of configuration file

    Connecting Deployment to Service to Pod

    Demo


    3 Parts of K8s Configuration File


    First - metadata

        Deployment

        apiVersion: apps/v1
        kind: Deployment                Kind of service
        metadata:
        name: nginx-deployment
        labels:
            app: nginx

    Second - specification

    Attributes of "spec" are specific to the kind

        spec:
        replicas: 2
        selector: 
            matchLabels:
            app: nginx
        template:
            metadata:
            labels:
                app: nginx
            spec:
            containers:
            - name: nginx
                image: nginx:1.25
                ports:
                - containerPort: 8080 

    Status - automatically auto-generated by kubernetes

    Will always compare what is the desired state and the actual state

    This is the basis of the self healing service that kubernetes provides

    When you run the apply K8s updates state continuously

    Where does K8s get this status data?

        That information comes from the cluster brain - etcd. Etcd holds the current status of any K8s component

Format of K8s Configuration File

    "human friendly" data serialization standard for all programming languages

    Syntax: strict indentation

        Use "Yaml Validator" to identify syntax issues

        Best practice is to store the config file with your code in Git


Blueprint for Pods (Template)

     Previously we looked at Deployment manage Pods

     Layers of Abstraction

        Deployment manages a ..

        ReplicaSet manages a ..

        Pod is an abstraction of ..

        Container  

    When you edit a deployment it cascades to lower layers 

        Template - Has it's own "metadata" and "spec" section

        Applies to Pod

        This will be the Blueprint for a Pod

        Image ?

        Port ?

        Name ?


    Connecting Deployment to Pods

        Connecting components (Labels & Selectors & Ports)

    metadata section contains the labels

        in metadata section you give any key-value pair for component

            app: nginx

        pods get the label through the template blueprint

        this label is matched by the selector 

            selector: 
            matchLabels:
            app: nginx  

        spec section contains selectors and points to labels in template

        template:
            metadata:
            labels:
                app: nginx


    Connecting Services to Deployment

        Deployment has its own label

                app: nginx

        Template has its own label

                app: nginx

        Selector has macthlabels:

                app: nginx


        In Kind: Service

             Metadata

                name: nginx-service

            Spec

                selector:

                    app: nginx

            This points to the name: nginx-deployment in kind: Deployment

                labels:

                    app: nginx

                template:
                  metadata:
                    labels:
                      app: nginx

                These are the Pods registered to this Service


        Ports in Service and Pod

                DB Service points to nginx (Port 80) Service, which point to the Pod targetPort: 8080

            Service

                spec:
                selector: 
                    app: nginx
                ports:
                - protocol: TCP
                    port: 80
                    targetPort: 8080



            Container

                spec:
                containers:
                - name: nginx
                    image: nginx:1.25
                    ports:
                    - containerPort: 8080 


            michaelbradley@Michaels-iMac-2 ~ % kubectl apply -f nginx-deployment.yaml

            deployment.apps/nginx-deployment configured


            michaelbradley@Michaels-iMac-2 ~ % kubectl apply -f nginx-service.yaml

            service/nginx-service created

            michaelbradley@Michaels-iMac-2 ~ % kubectl get pod

            NAME                                READY   STATUS    RESTARTS   AGE
            nginx-deployment-779d58b757-gshmg   1/1     Running   0          56s
            nginx-deployment-779d58b757-qvq9h   1/1     Running   0          59s


            michaelbradley@Michaels-iMac-2 ~ % kubectl get service

            NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
            kubernetes      ClusterIP   10.96.0.1       <none>        443/TCP   14h
            nginx-service   ClusterIP   10.106.106.43   <none>        80/TCP    2m8s





            michaelbradley@Michaels-iMac-2 ~ % kubectl get pod -o wide
            NAME                                READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES
            nginx-deployment-779d58b757-gshmg   1/1     Running   0          7m52s   10.244.0.9   minikube   <none>           <none>
            nginx-deployment-779d58b757-qvq9h   1/1     Running   0          7m55s   10.244.0.8   minikube   <none>           <none>

            michaelbradley@Michaels-iMac-2 ~ % kubectl describe service nginx-service
            Name:              nginx-service
            Namespace:         default
            Labels:            <none>
            Annotations:       <none>
            Selector:          app=nginx
            Type:              ClusterIP
            IP Family Policy:  SingleStack
            IP Families:       IPv4
            IP:                10.106.106.43
            IPs:               10.106.106.43
            Port:              <unset>  80/TCP
            TargetPort:        8080/TCP
            Endpoints:         10.244.0.8:8080,10.244.0.9:8080
            Session Affinity:  None
            Events:            <none>

            The describe service shows the two endpoints registered with the nginx-service

            Status was automatically generated
















        Service

        apiVersion: v1
        kind: Service                       Kind of Service
        metadata:
        name: nginx-service


        spec:
        selector: 
            app: nginx
        ports:
        - protocol: TCP
            port: 80
            targetPort: 8080


        Data is stored in the etcd and contains information for the entire cluster. Details can be found in the usage section, below.

        Kubernetes updates metadata constantly and be captured with the following command and captured in a file.

        kubectl get deployment nginx-deployment -o yaml > nginx-deployment-results.yaml

        michaelbradley@Michaels-iMac-2 ~ % for i in nginx-deployment.yaml nginx-service.yaml 
        for> do
        for> kubectl delete -f $i
        for> done
        deployment.apps "nginx-deployment" deleted
        service "nginx-service" deleted





# Usage

michaelbradley@Michaels-iMac-2 ~ % kubectl describe service nginx-service
Name:              nginx-service
Namespace:         default
Labels:            <none>
Annotations:       <none>
Selector:          app=nginx
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.106.106.43
IPs:               10.106.106.43
Port:              <unset>  80/TCP
TargetPort:        8080/TCP
Endpoints:         10.244.0.8:8080,10.244.0.9:8080
Session Affinity:  None
Events:            <none>

michaelbradley@Michaels-iMac-2 ~ % kubectl get pod -o wide
NAME                                READY   STATUS    RESTARTS   AGE     IP           NODE       NOMINATED NODE   READINESS GATES
nginx-deployment-779d58b757-gshmg   1/1     Running   0          7m52s   10.244.0.9   minikube   <none>           <none>
nginx-deployment-779d58b757-qvq9h   1/1     Running   0          7m55s   10.244.0.8   minikube   <none>           <none>


michaelbradley@Michaels-iMac-2 ~ % kubectl get deployment nginx-deployment -o yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    deployment.kubernetes.io/revision: "2"
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"labels":{"app":"nginx"},"name":"nginx-deployment","namespace":"default"},"spec":{"replicas":2,"selector":{"matchLabels":{"app":"nginx"}},"template":{"metadata":{"labels":{"app":"nginx"}},"spec":{"containers":[{"image":"nginx:1.25","name":"nginx","ports":[{"containerPort":8080}]}]}}}}
  creationTimestamp: "2024-08-08T13:55:19Z"
  generation: 3
  labels:
    app: nginx
  name: nginx-deployment
  namespace: default
  resourceVersion: "32166"
  uid: 61051228-88b6-48c6-b767-7b9b4de23d85
spec:
  progressDeadlineSeconds: 600
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: nginx
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx:1.25
        imagePullPolicy: IfNotPresent
        name: nginx
        ports:
        - containerPort: 8080
          protocol: TCP
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
status:
  availableReplicas: 2
  conditions:
  - lastTransitionTime: "2024-08-08T13:58:39Z"
    lastUpdateTime: "2024-08-08T13:58:39Z"
    message: Deployment has minimum availability.
    reason: MinimumReplicasAvailable
    status: "True"
    type: Available
  - lastTransitionTime: "2024-08-08T13:55:19Z"
    lastUpdateTime: "2024-08-08T17:52:26Z"
    message: ReplicaSet "nginx-deployment-779d58b757" has successfully progressed.
    reason: NewReplicaSetAvailable
    status: "True"
    type: Progressing
  observedGeneration: 3
  readyReplicas: 2
  replicas: 2
  updatedReplicas: 2

    